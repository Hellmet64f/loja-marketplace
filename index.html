<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loja Marketplace - Assinaturas</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0f172a;          /* azul-ard√≥sia escuro */
      --panel: #111827;       /* cinza-ard√≥sia muito escuro */
      --muted: #94a3b8;       /* cinza azulado */
      --text: #e5e7eb;        /* cinza claro */
      --brand: #22c55e;       /* verde destaque */
      --brand-2: #16a34a;     /* verde escuro */
      --card: #0b1220;        /* tom para cart√µes */
      --stroke: #1f2937;      /* bordas sutis */
      --warning: #f59e0b;     /* laranja */
      --danger: #ef4444;      /* vermelho erro */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 1200px at 90% -10%, rgba(34,197,94,.25), transparent 40%),
                  radial-gradient(1000px 800px at 10% 120%, rgba(124,58,237,.15), transparent 50%),
                  var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    header { position: sticky; top: 0; z-index: 10; background: rgba(17,24,39,.75); backdrop-filter: blur(8px); border-bottom: 1px solid var(--stroke); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
    .brand-badge { width:28px; height:28px; border-radius:8px; background: linear-gradient(135deg, var(--brand), var(--brand-2)); display:grid; place-items:center; color:#052e16; font-weight:900; }
    .actions { display:flex; gap:8px; align-items:center; }
    .btn { background: var(--brand); border:none; color:#052e16; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn:hover { background: var(--brand-2); color:#031a0c; }
    .chip { background:#0b1220; border:1px solid var(--stroke); color:var(--text); padding:8px 10px; border-radius:999px; cursor:pointer; }
    .muted { color: var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:16px; }
    .card { background: var(--card); border:1px solid var(--stroke); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .card .thumb { height:120px; border-radius:10px; display:grid; place-items:center; background:#0f172a; font-size:40px; }
    .card .meta { display:flex; justify-content:space-between; align-items:center; }
    .price { color: #86efac; font-weight:700; }
    .rating { color: #fde68a; }
    .header-row { display:flex; justify-content:space-between; align-items:center; gap:16px; }
    .searchbar { flex:1; display:flex; gap:8px; }
    input[type="search"], select { background:#0b1220; border:1px solid var(--stroke); color:var(--text); padding:10px 12px; border-radius:10px; width:100%; }
    /* Facebook button styling */
    #fbLoginBtn { background:#1877f2; color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:8px; }
    #fbLoginBtn:hover { background:#166fe5; }
    #userInfo { display:none; align-items:center; gap:10px; }
    #userAvatar { width:28px; height:28px; border-radius:50%; display:none; }
    .notice { background: #0b1220; border-bottom: 1px dashed var(--warning); color: var(--warning); padding: 10px 16px; font-weight: 600; }
    .notice code { color: #fde68a; }
    .error-box { background:#1f2937; border-left:4px solid var(--danger); color:#fecaca; padding:10px 12px; border-radius:8px; margin:12px 16px; display:none; white-space:pre-wrap; }
  </style>

  <!-- Open Graph / FB App config -->
  <meta property="fb:app_id" content="1363366952176543" />
  <meta property="og:site_name" content="Loja Marketplace" />
  <meta name="facebook-domain-verification" content="hellmet64f.github.io" />
</head>
<body>
  <!-- Facebook SDK root -->
  <div id="fb-root"></div>

  <header>
    <div class="notice">
      Aviso: Login do Facebook funciona apenas em dom√≠nios autorizados. Publique via GitHub Pages em https://hellmet64f.github.io/loja-marketplace/ e adicione este dom√≠nio no App do Facebook (Settings > Basic > App Domains). Para testar sem produ√ß√£o, use usu√°rios de teste no painel do app.
    </div>
    <div class="wrap header-row">
      <div class="brand">
        <div class="brand-badge">M</div>
        Loja de Assinaturas
      </div>
      <div class="actions">
        <!-- √Årea de usu√°rio -->
        <div class="muted" id="userInfo">
          <img id="userAvatar" alt="Avatar" />
          <span>Ol√°, <strong id="userName"></strong></span>
          <button class="chip" id="logoutButton" type="button">Sair</button>
        </div>
        <!-- Bot√£o de login Facebook -->
        <button id="fbLoginBtn" type="button" aria-label="Entrar com Facebook">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12.06C22 6.48 17.52 2 11.94 2 6.36 2 1.88 6.48 1.88 12.06c0 5.01 3.66 9.16 8.44 9.94v-7.03H7.9v-2.91h2.42V9.64c0-2.39 1.42-3.71 3.58-3.71 1.04 0 2.13.19 2.13.19v2.35h-1.2c-1.18 0-1.55.73-1.55 1.48v1.78h2.64l-.42 2.91H13.3V22c4.78-.78 8.44-4.93 8.44-9.94Z"/></svg>
          Entrar com Facebook
        </button>
      </div>
    </div>
  </header>

  <div id="fbError" class="error-box" role="alert" aria-live="assertive"></div>

  <main class="wrap">
    <!-- Chips de filtros adicionais (simples) -->
    <section class="filters">
      <div id="chips" class="chips">
        <div class="chip" data-chip="entrega-imediata">Entrega imediata</div>
        <div class="chip" data-chip="4k">Suporte 4K</div>
        <div class="chip" data-chip="perfil-privado">Perfil privado</div>
        <div class="chip" data-chip="garantia">Garantia</div>
      </div>
    </section>

    <!-- Grid de an√∫ncios -->
    <section id="grid" class="grid" aria-live="polite">
      <!-- Cards inseridos dinamicamente por marketplace.js -->
    </section>
  </main>

  <footer>
    <div class="wrap">Projeto de exemplo para marketplace de assinaturas. C√≥digo com coment√°rios explicativos.</div>
  </footer>

  <!-- Modal de detalhes do an√∫ncio -->
  <dialog id="detalhesModal">
    <div class="modal-head">
      <strong id="detalhesTitulo">Assinatura</strong>
      <button id="fecharModal" class="chip" aria-label="Fechar">Fechar</button>
    </div>
    <div class="modal-body">
      <div id="detalhesThumb" class="thumb" aria-hidden="true">üé¨</div>
      <div id="detalhesVendedor" class="muted"></div>
      <div id="detalhesDescricao"></div>
      <div class="meta">
        <span id="detalhesPreco" class="price"></span>
        <span id="detalhesAvaliacao" class="rating"></span>
      </div>
      <small class="muted">Observa√ß√£o: esta √© apenas uma simula√ß√£o para fins de demonstra√ß√£o.</small>
    </div>
    <div class="modal-actions">
      <button id="btnAdicionarCarrinho" class="chip">Adicionar ao carrinho</button>
      <button id="btnSimularCompra" class="btn">Simular compra</button>
    </div>
  </dialog>

  <!-- Scripts principais -->
  <script src="marketplace.js" defer></script>

  <!-- Facebook SDK robust loader and login flow -->
  <script>
    (function() {
      const APP_ID = '1363366952176543';
      const APP_VERSION = 'v19.0';
      const ALLOWED_HOSTS = new Set([
        'hellmet64f.github.io',
        'localhost',
        '127.0.0.1'
      ]);

      const fbErrorEl = document.getElementById('fbError');
      const fbLoginBtn = document.getElementById('fbLoginBtn');
      const userInfoEl = document.getElementById('userInfo');
      const userNameEl = document.getElementById('userName');
      const userAvatarEl = document.getElementById('userAvatar');
      const logoutBtn = document.getElementById('logoutButton');

      function showError(message, detail) {
        if (!fbErrorEl) return;
        fbErrorEl.style.display = 'block';
        fbErrorEl.textContent = message + (detail ? `\nDetalhes: ${detail}` : '');
        console.error('[FB-LOGIN]', message, detail || '');
      }

      function clearError() {
        if (fbErrorEl) { fbErrorEl.style.display = 'none'; fbErrorEl.textContent = ''; }
      }

      function validateEnvironment() {
        const host = location.hostname;
        if (!ALLOWED_HOSTS.has(host)) {
          showError('Dom√≠nio atual n√£o autorizado no App do Facebook.', `Host: ${host}. Adicione este dom√≠nio em App Domains ou use hellmet64f.github.io.`);
          return false;
        }
        if (!APP_ID || APP_ID === 'YOUR_FB_APP_ID') {
          showError('Configura√ß√£o appId ausente ou inv√°lida.', 'Defina APP_ID corretamente.');
          return false;
        }
        return true;
      }

      // Prevent duplicate SDK injection
      function ensureFbSdkInjected() {
        if (document.getElementById('facebook-jssdk')) return true;
        const js = document.createElement('script');
        js.id = 'facebook-jssdk';
        js.async = true;
        js.defer = true;
        js.crossOrigin = 'anonymous';
        js.src = 'https://connect.facebook.net/pt_BR/sdk.js';
        js.onerror = () => showError('Falha ao carregar o SDK do Facebook.', 'Verifique conex√£o, bloqueadores e CORS.');
        const fjs = document.getElementsByTagName('script')[0] || document.body;
        fjs.parentNode.insertBefore(js, fjs);
        return false; // will be ready later
      }

      function updateUIForUser(user) {
        if (user) {
          userNameEl.textContent = user.name || '';
          if (user.picture && user.picture.data && user.picture.data.url) {
            userAvatarEl.src = user.picture.data.url;
            userAvatarEl.style.display = 'block';
          } else {
            userAvatarEl.style.display = 'none';
          }
          userInfoEl.style.display = 'flex';
          if (fbLoginBtn) fbLoginBtn.style.display = 'none';
        } else {
          userNameEl.textContent = '';
          userAvatarEl.style.display = 'none';
          userInfoEl.style.display = 'none';
          if (fbLoginBtn) fbLoginBtn.style.display = 'inline-flex';
        }
      }

      function fetchUserProfile() {
        FB.api('/me', { fields: 'name,picture.width(64).height(64)' }, function(response) {
          if (!response || response.error) {
            const detail = response && response.error ? `${response.error.type || ''} ${response.error.code || ''} ${response.error.message || ''}`.trim() : 'Resposta vazia';
            showError('Erro ao buscar perfil do usu√°rio.', detail);
            updateUIForUser(null);
            return;
          }
          clearError();
          updateUIForUser(response);
        });
      }

      function ensureLoginAndFetchProfile() {
        clearError();
        if (!window.FB) {
          showError('SDK do Facebook ainda n√£o est√° pronto.', 'Aguarde o carregamento do SDK e tente novamente.');
          return;
        }
        FB.getLoginStatus(function(statusResponse) {
          if (!statusResponse) {
            showError('N√£o foi poss√≠vel obter o status de login.');
            return;
          }
          if (statusResponse.status === 'connected') {
            fetchUserProfile();
          } else {
            FB.login(function(loginResponse) {
              if (loginResponse && loginResponse.authResponse) {
                fetchUserProfile();
              } else {
                showError('Login com Facebook cancelado ou negado pelo usu√°rio.');
              }
            }, { scope: 'public_profile' });
          }
        });
      }

      function initFb() {
        if (!validateEnvironment()) return;
        window.fbAsyncInit = function() {
          try {
            FB.init({
              appId: APP_ID,
              cookie: true,
              xfbml: false,
              version: APP_VERSION,
              status: true
            });
            // Optionally check status on init
            FB.getLoginStatus(function(res){ if (res && res.status === 'connected') fetchUserProfile(); });
          } catch (e) {
            showError('Falha ao inicializar o Facebook SDK.', String(e));
          }
        };
        ensureFbSdkInjected();
      }

      // Wire UI events
      fbLoginBtn?.addEventListener('click', ensureLoginAndFetchProfile);
      logoutBtn?.addEventListener('click', function() {
        if (!window.FB) { updateUIForUser(null); return; }
        FB.logout(function() {
          updateUIForUser(null);
        });
      });

      // Init on load
      window.addEventListener('load', function()
